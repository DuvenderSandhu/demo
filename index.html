<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyDocs - Simple Document Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --light-color: #f0f4f8;
            --dark-color: #2c3e50;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Toolbar Styles */
        .toolbar {
            background-color: white;
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: var(--shadow);
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
            padding: 5px;
            border-right: 1px solid #eee;
            margin-right: 10px;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-button {
            background-color: var(--light-color);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 50px;
            justify-content: center;
        }

        .toolbar-button:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        .toolbar-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .toolbar-button.voice {
            background-color: var(--success-color);
            color: white;
        }

        .toolbar-button.voice.recording {
            background-color: var(--accent-color);
            animation: pulse 1.5s infinite;
        }

        .toolbar-button.export {
            background-color: var(--success-color);
            color: white;
        }

        select, input[type="color"] {
            padding: 8px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        /* Editor Styles */
        .editor-container {
            flex: 1;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        #editor {
            background-color: white;
            min-height: 500px;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            font-size: 16px;
            line-height: 1.8;
            outline: none;
            border: 1px solid #ddd;
            position: relative;
        }

        #editor:focus {
            border-color: var(--primary-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .modal-input-group {
            margin-bottom: 15px;
        }

        .modal-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .modal-input-group input {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 1rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
        }

        .modal-button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-button.secondary {
            background-color: #ddd;
            color: var(--dark-color);
        }

        /* Status Bar */
        .status-bar {
            background-color: var(--light-color);
            padding: 10px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }

        /* Animation for voice recording */
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        /* Table Styles */
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            position: relative;
        }

        table, th, td {
            border: 2px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: left;
            position: relative;
            min-height: 40px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            vertical-align: top;
            cursor: pointer;
            min-width: 80px;
        }

        th {
            background-color: var(--light-color);
            font-weight: bold;
        }

        .table-cell.selected {
            background-color: rgba(74, 111, 165, 0.3) !important;
            border: 2px solid var(--primary-color) !important;
        }

        .table-cell {
            position: relative;
        }

        .cell-voice-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 10;
        }

        .table-cell:hover .cell-voice-btn {
            display: flex;
        }

        /* Image Styles */
        .editor-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            position: relative;
            display: inline-block;
            cursor: pointer;
            border: 2px dashed transparent;
            transition: border-color 0.3s;
        }

        .editor-image:hover {
            border-color: var(--primary-color);
        }

        .editor-image.selected {
            outline: 2px solid var(--primary-color);
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-radius: 50%;
            z-index: 20;
            display: none;
        }

        .editor-image.selected .resize-handle {
            display: block;
        }

        .resize-handle.top-left {
            top: -6px;
            left: -6px;
            cursor: nwse-resize;
        }

        .resize-handle.top-right {
            top: -6px;
            right: -6px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-left {
            bottom: -6px;
            left: -6px;
            cursor: nesw-resize;
        }

        .resize-handle.bottom-right {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }

        /* Voice Modal */
        .voice-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .voice-modal h3 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .voice-status {
            padding: 15px;
            background: var(--light-color);
            border-radius: var(--border-radius);
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .voice-status.recording {
            background: #ffeaa7;
            color: #d63031;
        }

        .voice-text {
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
            font-size: 1rem;
            text-align: left;
            background: #f8f9fa;
        }

        .voice-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Permission Modal */
        .permission-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1002;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .permission-modal i {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        /* Image Size Modal */
        .image-size-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
        }

        .size-inputs {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .size-input {
            flex: 1;
        }

        .size-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .size-input input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .toolbar {
                justify-content: center;
            }
            
            .toolbar-group {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Content -->
        <main class="main-content">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-button" id="bold-btn" title="Bold"><i class="fas fa-bold"></i></button>
                    <button class="toolbar-button" id="italic-btn" title="Italic"><i class="fas fa-italic"></i></button>
                    <button class="toolbar-button" id="underline-btn" title="Underline"><i class="fas fa-underline"></i></button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="font-increase" title="Increase Font Size"><i class="fas fa-plus"></i> A+</button>
                    <button class="toolbar-button" id="font-decrease" title="Decrease Font Size"><i class="fas fa-minus"></i> A-</button>
                </div>
                
                <div class="toolbar-group">
                    <label for="text-color"><i class="fas fa-palette"></i></label>
                    <input type="color" id="text-color" value="#000000">
                    <label for="bg-color"><i class="fas fa-fill-drip"></i></label>
                    <input type="color" id="bg-color" value="#ffffff">
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="align-left" title="Align Left"><i class="fas fa-align-left"></i></button>
                    <button class="toolbar-button" id="align-center" title="Align Center"><i class="fas fa-align-center"></i></button>
                    <button class="toolbar-button" id="align-right" title="Align Right"><i class="fas fa-align-right"></i></button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="insert-image" title="Insert Image"><i class="fas fa-image"></i> Image</button>
                    <button class="toolbar-button" id="image-size" title="Adjust Image Size"><i class="fas fa-expand"></i> Size</button>
                    <button class="toolbar-button" id="insert-table" title="Insert Table"><i class="fas fa-table"></i> Table</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="merge-cells" title="Merge Cells"><i class="fas fa-object-group"></i> Merge</button>
                    <button class="toolbar-button" id="split-cells" title="Split Cells"><i class="fas fa-object-ungroup"></i> Split</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button voice" id="voice-btn" title="Voice Typing"><i class="fas fa-microphone"></i> Voice Type</button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button export" id="export-pdf" title="Export as PDF"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="toolbar-button export" id="export-docx" title="Export as Word"><i class="fas fa-file-word"></i> Word</button>
                </div>
            </div>
            
            <!-- Editor Area -->
            <div class="editor-container">
                <div id="editor" contenteditable="true">
                    <h1>Welcome to EasyDocs</h1>
                    <p>This is your new document. Start typing here or use the toolbar above to format your text.</p>
                    <p><strong>Try these features:</strong></p>
                    <ul>
                        <li>Select text and use A+ or A- to change font size</li>
                        <li>Click "Table" to insert a table (try 3 rows, 1 column)</li>
                        <li>Click on table cells to select them, then click Merge</li>
                        <li>Click "Image" to insert and resize images</li>
                        <li>Use "Voice Type" for hands-free typing</li>
                    </ul>
                    <p>Have fun creating!</p>
                </div>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div id="word-count">Words: 0</div>
                <div id="voice-status">Voice: Ready</div>
            </div>
        </main>
    </div>
    
    <!-- Table Creation Modal -->
    <div class="modal" id="table-modal">
        <div class="modal-content">
            <h2><i class="fas fa-table"></i> Create Table</h2>
            <div class="modal-input-group">
                <label for="table-rows">Number of Rows:</label>
                <input type="number" id="table-rows" min="1" max="20" value="3">
            </div>
            <div class="modal-input-group">
                <label for="table-cols">Number of Columns:</label>
                <input type="number" id="table-cols" min="1" max="10" value="3">
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="table-cancel">Cancel</button>
                <button class="modal-button primary" id="table-insert">Insert Table</button>
            </div>
        </div>
    </div>
    
    <!-- Split Cell Modal -->
    <div class="modal" id="split-modal">
        <div class="modal-content">
            <h2><i class="fas fa-object-ungroup"></i> Split Cell</h2>
            <div class="modal-input-group">
                <label for="split-rows">Number of Rows:</label>
                <input type="number" id="split-rows" min="1" max="10" value="1">
            </div>
            <div class="modal-input-group">
                <label for="split-cols">Number of Columns:</label>
                <input type="number" id="split-cols" min="1" max="10" value="2">
            </div>
            <div class="modal-buttons">
                <button class="modal-button secondary" id="split-cancel">Cancel</button>
                <button class="modal-button primary" id="split-insert">Split Cell</button>
            </div>
        </div>
    </div>
    
    <!-- Image Size Modal -->
    <div class="image-size-modal" id="image-size-modal">
        <h2><i class="fas fa-expand"></i> Adjust Image Size</h2>
        <div class="size-inputs">
            <div class="size-input">
                <label for="image-width">Width (px):</label>
                <input type="number" id="image-width" min="50" max="2000" value="300">
            </div>
            <div class="size-input">
                <label for="image-height">Height (px):</label>
                <input type="number" id="image-height" min="50" max="2000" value="200">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-button secondary" id="size-cancel">Cancel</button>
            <button class="modal-button primary" id="size-apply">Apply Size</button>
        </div>
    </div>
    
    <!-- Voice Permission Modal -->
    <div class="permission-modal" id="permission-modal">
        <i class="fas fa-microphone"></i>
        <h3>Voice Typing Permission</h3>
        <p>EasyDocs needs access to your microphone for voice typing.</p>
        <p>Click "Allow" when the browser asks for microphone permission.</p>
        <div class="modal-buttons">
            <button class="modal-button primary" id="permission-ok">OK, I Understand</button>
        </div>
    </div>
    
    <!-- Voice Typing Modal -->
    <div class="voice-modal" id="voice-modal">
        <h3><i class="fas fa-microphone"></i> Voice Typing</h3>
        <div class="voice-status" id="voice-status-text">Click "Start Recording" to begin</div>
        <div class="voice-text" id="voice-text">Your speech will appear here...</div>
        <div class="voice-buttons">
            <button class="modal-button secondary" id="voice-cancel">Cancel</button>
            <button class="modal-button" id="voice-record"><i class="fas fa-microphone"></i> Start Recording</button>
            <button class="modal-button primary" id="voice-insert">Insert Text</button>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // DOM Elements
        const editor = document.getElementById('editor');
        const boldBtn = document.getElementById('bold-btn');
        const italicBtn = document.getElementById('italic-btn');
        const underlineBtn = document.getElementById('underline-btn');
        const fontIncreaseBtn = document.getElementById('font-increase');
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const textColor = document.getElementById('text-color');
        const bgColor = document.getElementById('bg-color');
        const alignLeftBtn = document.getElementById('align-left');
        const alignCenterBtn = document.getElementById('align-center');
        const alignRightBtn = document.getElementById('align-right');
        const insertImageBtn = document.getElementById('insert-image');
        const imageSizeBtn = document.getElementById('image-size');
        const insertTableBtn = document.getElementById('insert-table');
        const mergeCellsBtn = document.getElementById('merge-cells');
        const splitCellsBtn = document.getElementById('split-cells');
        const voiceBtn = document.getElementById('voice-btn');
        const exportPdfBtn = document.getElementById('export-pdf');
        const exportDocxBtn = document.getElementById('export-docx');
        const tableModal = document.getElementById('table-modal');
        const tableInsertBtn = document.getElementById('table-insert');
        const tableCancelBtn = document.getElementById('table-cancel');
        const splitModal = document.getElementById('split-modal');
        const splitInsertBtn = document.getElementById('split-insert');
        const splitCancelBtn = document.getElementById('split-cancel');
        const imageSizeModal = document.getElementById('image-size-modal');
        const sizeApplyBtn = document.getElementById('size-apply');
        const sizeCancelBtn = document.getElementById('size-cancel');
        const wordCount = document.getElementById('word-count');
        const voiceStatus = document.getElementById('voice-status');
        const voiceModal = document.getElementById('voice-modal');
        const voiceText = document.getElementById('voice-text');
        const voiceCancel = document.getElementById('voice-cancel');
        const voiceRecord = document.getElementById('voice-record');
        const voiceInsert = document.getElementById('voice-insert');
        const permissionModal = document.getElementById('permission-modal');
        const permissionOk = document.getElementById('permission-ok');
        const voiceStatusText = document.getElementById('voice-status-text');

        // Global variables
        let recognition = null;
        let isListening = false;
        let cursorPosition = null;
        let selectedCells = [];
        let selectedImage = null;

        // Initialize speech recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // Update voice text area
                    voiceText.innerHTML = finalTranscript + '<span style="color: #666;">' + interimTranscript + '</span>';
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    voiceStatusText.textContent = 'Error: ' + event.error;
                    voiceStatusText.className = 'voice-status';
                    isListening = false;
                    voiceRecord.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                };

                recognition.onend = function() {
                    if (isListening) {
                        recognition.start();
                    }
                };
            }
        }

        // Save cursor position before opening voice modal
        function saveCursorPosition() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                cursorPosition = range.cloneRange();
            }
        }

        // Restore cursor position after voice input
        function restoreCursorPosition() {
            if (cursorPosition) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(cursorPosition);
            }
        }

        // Formatting Functions
        boldBtn.addEventListener('click', () => {
            document.execCommand('bold', false, null);
        });

        italicBtn.addEventListener('click', () => {
            document.execCommand('italic', false, null);
        });

        underlineBtn.addEventListener('click', () => {
            document.execCommand('underline', false, null);
        });

        // Fixed Font size controls
        fontIncreaseBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().length > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                // Get current font size or use default
                let currentSize = 16;
                const parentElement = range.commonAncestorContainer.parentElement;
                if (parentElement && parentElement.style.fontSize) {
                    currentSize = parseInt(parentElement.style.fontSize);
                }
                
                // Increase font size
                const newSize = Math.min(currentSize + 2, 72);
                
                // Create span with new font size
                const span = document.createElement('span');
                span.style.fontSize = newSize + 'px';
                span.textContent = selectedText;
                
                // Replace selected text with styled span
                range.deleteContents();
                range.insertNode(span);
            } else {
                // If no text selected, apply to the whole paragraph
                const blockElement = getBlockElement(selection.anchorNode);
                if (blockElement) {
                    let currentSize = parseInt(window.getComputedStyle(blockElement).fontSize) || 16;
                    const newSize = Math.min(currentSize + 2, 72);
                    blockElement.style.fontSize = newSize + 'px';
                }
            }
        });

        fontDecreaseBtn.addEventListener('click', () => {
            const selection = window.getSelection();
            if (selection.rangeCount > 0 && selection.toString().length > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                
                // Get current font size or use default
                let currentSize = 16;
                const parentElement = range.commonAncestorContainer.parentElement;
                if (parentElement && parentElement.style.fontSize) {
                    currentSize = parseInt(parentElement.style.fontSize);
                }
                
                // Decrease font size
                const newSize = Math.max(currentSize - 2, 8);
                
                // Create span with new font size
                const span = document.createElement('span');
                span.style.fontSize = newSize + 'px';
                span.textContent = selectedText;
                
                // Replace selected text with styled span
                range.deleteContents();
                range.insertNode(span);
            } else {
                // If no text selected, apply to the whole paragraph
                const blockElement = getBlockElement(selection.anchorNode);
                if (blockElement) {
                    let currentSize = parseInt(window.getComputedStyle(blockElement).fontSize) || 16;
                    const newSize = Math.max(currentSize - 2, 8);
                    blockElement.style.fontSize = newSize + 'px';
                }
            }
        });

        // Helper function to get block element
        function getBlockElement(node) {
            while (node && node !== editor) {
                if (node.nodeType === Node.ELEMENT_NODE && 
                    (node.tagName === 'P' || node.tagName === 'DIV' || 
                     node.tagName === 'H1' || node.tagName === 'H2' || 
                     node.tagName === 'H3' || node.tagName === 'H4' || 
                     node.tagName === 'H5' || node.tagName === 'H6' || 
                     node.tagName === 'LI')) {
                    return node;
                }
                node = node.parentNode;
            }
            return null;
        }

        textColor.addEventListener('input', () => {
            document.execCommand('foreColor', false, textColor.value);
        });

        bgColor.addEventListener('input', () => {
            document.execCommand('hiliteColor', false, bgColor.value);
        });

        alignLeftBtn.addEventListener('click', () => {
            document.execCommand('justifyLeft', false, null);
        });

        alignCenterBtn.addEventListener('click', () => {
            document.execCommand('justifyCenter', false, null);
        });

        alignRightBtn.addEventListener('click', () => {
            document.execCommand('justifyRight', false, null);
        });

        // Insert Image with resize handles
        insertImageBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.className = 'editor-image';
                        img.style.width = '300px';
                        img.style.height = 'auto';
                        
                        // Add resize handles
                        addImageResizeHandles(img);
                        
                        // Make image selectable
                        img.addEventListener('click', (e) => {
                            e.stopPropagation();
                            clearSelections();
                            img.classList.add('selected');
                            selectedImage = img;
                            
                            // Update image size modal with current dimensions
                            document.getElementById('image-width').value = parseInt(img.style.width) || img.naturalWidth;
                            document.getElementById('image-height').value = parseInt(img.style.height) || img.naturalHeight;
                        });
                        
                        // Insert at cursor position
                        insertElementAtCursor(img);
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            input.click();
        });

        // Image size adjustment modal
        imageSizeBtn.addEventListener('click', () => {
            if (selectedImage) {
                imageSizeModal.style.display = 'block';
            } else {
                alert('Please select an image first by clicking on it.');
            }
        });

        sizeApplyBtn.addEventListener('click', () => {
            if (selectedImage) {
                const width = document.getElementById('image-width').value;
                const height = document.getElementById('image-height').value;
                
                selectedImage.style.width = width + 'px';
                selectedImage.style.height = height + 'px';
                
                imageSizeModal.style.display = 'none';
            }
        });

        sizeCancelBtn.addEventListener('click', () => {
            imageSizeModal.style.display = 'none';
        });

        // Add resize handles to image
        function addImageResizeHandles(img) {
            const handles = [
                { position: 'top-left', cursor: 'nwse-resize' },
                { position: 'top-right', cursor: 'nesw-resize' },
                { position: 'bottom-left', cursor: 'nesw-resize' },
                { position: 'bottom-right', cursor: 'nwse-resize' }
            ];
            
            let isResizing = false;
            let startWidth, startHeight, startX, startY, handlePosition;
            
            handles.forEach(handle => {
                const resizeHandle = document.createElement('div');
                resizeHandle.className = `resize-handle ${handle.position}`;
                resizeHandle.style.cursor = handle.cursor;
                img.appendChild(resizeHandle);
                
                // Add resize functionality
                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    handlePosition = handle.position;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = parseInt(document.defaultView.getComputedStyle(img).width, 10) || img.naturalWidth;
                    startHeight = parseInt(document.defaultView.getComputedStyle(img).height, 10) || img.naturalHeight;
                    e.preventDefault();
                    e.stopPropagation();
                    
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                });
            });
            
            function resize(e) {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                
                if (handlePosition.includes('right')) {
                    newWidth = startWidth + dx;
                }
                if (handlePosition.includes('left')) {
                    newWidth = startWidth - dx;
                }
                if (handlePosition.includes('bottom')) {
                    newHeight = startHeight + dy;
                }
                if (handlePosition.includes('top')) {
                    newHeight = startHeight - dy;
                }
                
                // Set minimum size
                newWidth = Math.max(newWidth, 50);
                newHeight = Math.max(newHeight, 50);
                
                img.style.width = newWidth + 'px';
                img.style.height = newHeight + 'px';
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // Insert Table - Fixed implementation
        insertTableBtn.addEventListener('click', () => {
            tableModal.style.display = 'flex';
        });

        tableCancelBtn.addEventListener('click', () => {
            tableModal.style.display = 'none';
        });

        tableInsertBtn.addEventListener('click', () => {
            const rows = parseInt(document.getElementById('table-rows').value) || 3;
            const cols = parseInt(document.getElementById('table-cols').value) || 3;
            
            const table = document.createElement('table');
            for (let i = 0; i < rows; i++) {
                const tr = document.createElement('tr');
                for (let j = 0; j < cols; j++) {
                    const cell = document.createElement('td');
                    cell.className = 'table-cell';
                    cell.contentEditable = true;
                    cell.innerHTML = 'Cell ' + (i + 1) + ',' + (j + 1);
                    
                    // Add voice button to each cell
                    const voiceBtn = document.createElement('button');
                    voiceBtn.className = 'cell-voice-btn';
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    voiceBtn.title = 'Voice input for this cell';
                    
                    voiceBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        saveCursorPosition();
                        voiceModal.style.display = 'block';
                        startVoiceInput();
                    });
                    
                    cell.appendChild(voiceBtn);
                    
                    // Add cell selection
                    cell.addEventListener('click', (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            // Multi-select with Ctrl/Cmd key
                            cell.classList.toggle('selected');
                            if (cell.classList.contains('selected')) {
                                if (!selectedCells.includes(cell)) {
                                    selectedCells.push(cell);
                                }
                            } else {
                                const index = selectedCells.indexOf(cell);
                                if (index > -1) {
                                    selectedCells.splice(index, 1);
                                }
                            }
                        } else {
                            // Single select
                            clearSelections();
                            cell.classList.add('selected');
                            selectedCells = [cell];
                        }
                        e.stopPropagation();
                    });
                    
                    tr.appendChild(cell);
                }
                table.appendChild(tr);
            }
            
            insertElementAtCursor(table);
            tableModal.style.display = 'none';
        });

        // Clear all selections
        function clearSelections() {
            // Clear table cell selections
            const selected = editor.querySelectorAll('.selected, .table-cell.selected');
            selected.forEach(el => el.classList.remove('selected'));
            selectedCells = [];
            
            // Clear image selections
            const selectedImages = editor.querySelectorAll('.editor-image.selected');
            selectedImages.forEach(img => img.classList.remove('selected'));
            selectedImage = null;
        }

        // Clear selections when clicking outside
        editor.addEventListener('click', (e) => {
            if (!e.target.closest('.table-cell') && !e.target.closest('.editor-image')) {
                clearSelections();
            }
        });

        // Merge Cells - Fixed implementation
        mergeCellsBtn.addEventListener('click', () => {
            if (selectedCells.length > 1) {
                // Sort cells by position
                selectedCells.sort((a, b) => {
                    const aRow = a.parentNode.rowIndex;
                    const bRow = b.parentNode.rowIndex;
                    if (aRow !== bRow) return aRow - bRow;
                    return a.cellIndex - b.cellIndex;
                });
                
                // Get the first cell
                const firstCell = selectedCells[0];
                
                // Calculate rowspan and colspan
                const rows = new Set(selectedCells.map(cell => cell.parentNode.rowIndex));
                const cols = new Set(selectedCells.map(cell => cell.cellIndex));
                
                const rowspan = rows.size;
                const colspan = cols.size;
                
                // Set rowspan and colspan
                firstCell.rowSpan = rowspan;
                firstCell.colSpan = colspan;
                
                // Move content from other cells to first cell
                let combinedContent = firstCell.innerHTML;
                for (let i = 1; i < selectedCells.length; i++) {
                    combinedContent += '<br>' + selectedCells[i].innerHTML;
                    selectedCells[i].parentNode.removeChild(selectedCells[i]);
                }
                
                firstCell.innerHTML = combinedContent;
                
                // Clear selections
                clearSelections();
                firstCell.classList.add('selected');
                selectedCells = [firstCell];
            } else {
                alert('Please select multiple cells to merge. Hold Ctrl/Cmd and click cells to select multiple.');
            }
        });

        // Split Cells
        splitCellsBtn.addEventListener('click', () => {
            if (selectedCells.length === 1) {
                const cell = selectedCells[0];
                splitModal.style.display = 'flex';
                
                // Store the cell to split
                window.cellToSplit = cell;
            } else {
                alert('Please select a single cell to split.');
            }
        });

        splitCancelBtn.addEventListener('click', () => {
            splitModal.style.display = 'none';
        });

        splitInsertBtn.addEventListener('click', () => {
            const cell = window.cellToSplit;
            if (cell) {
                const splitRows = parseInt(document.getElementById('split-rows').value) || 1;
                const splitCols = parseInt(document.getElementById('split-cols').value) || 2;
                
                const row = cell.parentNode;
                const table = row.parentNode;
                const cellIndex = Array.from(row.cells).indexOf(cell);
                
                // Get current rowspan and colspan
                const currentRowspan = cell.rowSpan || 1;
                const currentColspan = cell.colSpan || 1;
                
                // Remove the cell
                row.removeChild(cell);
                
                // Insert new cells
                for (let r = 0; r < splitRows; r++) {
                    for (let c = 0; c < splitCols; c++) {
                        const newCell = document.createElement('td');
                        newCell.className = 'table-cell';
                        newCell.contentEditable = true;
                        newCell.innerHTML = 'Cell ' + (r + 1) + ',' + (c + 1);
                        
                        // Add voice button
                        const voiceBtn = document.createElement('button');
                        voiceBtn.className = 'cell-voice-btn';
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceBtn.title = 'Voice input for this cell';
                        voiceBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            saveCursorPosition();
                            voiceModal.style.display = 'block';
                            startVoiceInput();
                        });
                        newCell.appendChild(voiceBtn);
                        
                        // Add selection
                        newCell.addEventListener('click', (e) => {
                            if (e.ctrlKey || e.metaKey) {
                                newCell.classList.toggle('selected');
                                if (newCell.classList.contains('selected')) {
                                    if (!selectedCells.includes(newCell)) {
                                        selectedCells.push(newCell);
                                    }
                                } else {
                                    const index = selectedCells.indexOf(newCell);
                                    if (index > -1) {
                                        selectedCells.splice(index, 1);
                                    }
                                }
                            } else {
                                clearSelections();
                                newCell.classList.add('selected');
                                selectedCells = [newCell];
                            }
                            e.stopPropagation();
                        });
                        
                        row.insertBefore(newCell, row.cells[cellIndex + c] || null);
                    }
                }
                
                splitModal.style.display = 'none';
                clearSelections();
            }
        });

        // Voice Typing
        function startVoiceInput() {
            if (!recognition) {
                initSpeechRecognition();
            }
            
            if (recognition) {
                recognition.start();
                isListening = true;
                voiceStatusText.textContent = 'Recording... Speak now!';
                voiceStatusText.className = 'voice-status recording';
                voiceRecord.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                voiceStatus.textContent = 'Voice: Recording';
            }
        }

        function stopVoiceInput() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                voiceStatusText.textContent = 'Recording stopped';
                voiceStatusText.className = 'voice-status';
                voiceRecord.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                voiceStatus.textContent = 'Voice: Ready';
            }
        }

        // Voice button opens permission modal first
        voiceBtn.addEventListener('click', () => {
            permissionModal.style.display = 'block';
        });

        permissionOk.addEventListener('click', () => {
            permissionModal.style.display = 'none';
            saveCursorPosition();
            voiceModal.style.display = 'block';
            voiceText.textContent = 'Your speech will appear here...';
        });

        voiceRecord.addEventListener('click', () => {
            if (isListening) {
                stopVoiceInput();
            } else {
                startVoiceInput();
            }
        });

        voiceCancel.addEventListener('click', () => {
            voiceModal.style.display = 'none';
            stopVoiceInput();
        });

        voiceInsert.addEventListener('click', () => {
            const text = voiceText.textContent || voiceText.innerText;
            if (text && text !== 'Your speech will appear here...') {
                restoreCursorPosition();
                insertTextAtCursor(text);
            }
            voiceModal.style.display = 'none';
            stopVoiceInput();
        });

        // Helper function to insert text at cursor
        function insertTextAtCursor(text) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(text);
                range.insertNode(textNode);
                range.setStartAfter(textNode);
                range.setEndAfter(textNode);
                selection.removeAllRanges();
                selection.addRange(range);
            }
            
            updateWordCount();
        }

        // Helper function to insert element at cursor
        function insertElementAtCursor(element) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(element);
            } else {
                editor.appendChild(element);
            }
        }

        // Export Functions - Working implementations
        exportPdfBtn.addEventListener('click', () => {
            // Use html2canvas and jsPDF for PDF export
            html2canvas(editor).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF();
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save('easydocs-document.pdf');
            });
        });

        exportDocxBtn.addEventListener('click', () => {
            // Create a simple DOCX export
            const content = editor.innerHTML;
            const blob = new Blob([`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>EasyDocs Document</title>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `], { type: 'application/msword' });
            
            saveAs(blob, 'easydocs-document.doc');
        });

        // Word Count
        function updateWordCount() {
            const text = editor.innerText || '';
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            wordCount.textContent = `Words: ${words}`;
        }

        editor.addEventListener('input', updateWordCount);
        updateWordCount();

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === tableModal) {
                tableModal.style.display = 'none';
            }
            if (e.target === splitModal) {
                splitModal.style.display = 'none';
            }
            if (e.target === imageSizeModal) {
                imageSizeModal.style.display = 'none';
            }
            if (e.target === permissionModal) {
                permissionModal.style.display = 'none';
            }
            if (e.target === voiceModal) {
                voiceModal.style.display = 'none';
                stopVoiceInput();
            }
        });
    </script>
</body>
</html>
